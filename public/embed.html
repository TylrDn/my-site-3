<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>MacroSight Embed</title>
    <link rel="stylesheet" href="/styles.css" />
    <style>
      .loader {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        font-size: 1.2rem;
        color: var(--color-muted);
      }

      .loader::after {
        content: '';
        width: 20px;
        height: 20px;
        margin-left: 10px;
        border: 2px solid var(--color-border);
        border-top: 2px solid var(--color-accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
    <script defer src="/scripts/responsive-iframe.js"></script>
  </head>
  <body>
    <div class="loader">Loading</div>
    <noscript>
      This page is meant to be embedded.
      <a href="https://www.macrosight.net/home">Go to Home</a>
    </noscript>
    <div class="iframe-container" style="--iframe-aspect: 16/9">
      <iframe data-ri title="Embedded content"></iframe>
    </div>
    <script>
      // Hardened postMessage injection for Wix Velo
      const ALLOWED_PARENTS = [
        'https://www.wix.com',
        'https://*.wix.com',
        'https://*.wixsite.com',
        'https://editor.wix.com',
        'https://editor.wixstudio.com',
        'https://manage.wix.com',
      ];

      // Test-only: allow local origins to simulate Wix in CI
      try {
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
          ALLOWED_PARENTS.push(window.location.origin);
        }
      } catch {}

      function patternToRegex(pattern) {
        const escaped = pattern.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&').replace(/\\\*/g, '[^.]+');
        return new RegExp(`^${escaped}$`);
      }

      function isAllowedOrigin(origin) {
        return ALLOWED_PARENTS.some((p) => patternToRegex(p).test(origin));
      }

      function safeInject({ html, css }) {
        if (typeof html !== 'string') return false;

        const bodyMatch = html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
        const bodyContent = bodyMatch ? bodyMatch[1] : html;

        if (/<(script|style)[\s>]/i.test(bodyContent)) return false;

        document.body.innerHTML = '';
        if (typeof css === 'string' && css.trim() !== '') {
          const style = document.createElement('style');
          style.textContent = css;
          document.body.appendChild(style);
        }
        document.body.insertAdjacentHTML('beforeend', bodyContent);
        return true;
      }

      window.addEventListener(
        'message',
        (event) => {
          if (!isAllowedOrigin(event.origin)) return;
          const { type, html, css } = event.data || {};
          if (type !== 'INJECT') return;

          if (safeInject({ html, css })) {
            const loader = document.querySelector('.loader');
            if (loader) loader.style.display = 'none';
          } else {
            document.body.innerHTML =
              '<div style="padding:2em;text-align:center;color:#c00;">Sorry, content failed to load. Please try again later.</div>';
          }
        },
        false
      );
    </script>
    <script src="/mobile-nav.js" defer></script>
  </body>
</html>
